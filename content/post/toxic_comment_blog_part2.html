---
title: "Flagging Toxic Comments Part 2"
author: ''
date: '2020-01-16'
description: Feature Engineering and Text Classification with Logistic Regression

slug: toxic_comment_blog_part2
tags: []
categories: Machine Learning
topics: []
---



<p>In the <a href="https://wambuimuriuki.netlify.com/post/toxic_comment_blog_part1/">previous post</a>, we used words to classify Wikipedia comments as harmful or harmless. In this post, we will create a few features from the comments and build another classification model.</p>
<p><em>To explore features, we will use R as I prefer using R ggplot2</em></p>
<p>We will start by reading Kaggle’s training dataset, create column “harmful” then select columns “comment_text” and “harmful”.</p>
<pre class="r"><code>library(dplyr)
library(caTools)
library(ggplot2)
library(gridExtra)
library(stringr)
library(ngram)
library(tm)</code></pre>
<pre class="r"><code>train &lt;- readRDS(&quot;Kaggle-Toxic-Comment-Challenge/Data/train.rds&quot;)
train$comment_text = as.character(train$comment_text)
train$toxicity_score = rowSums(train[,3:8])
train$harmful = as.factor(if_else(train$toxicity_score == 0, 0, 1))
train = train %&gt;%
  select(comment_text, harmful)
head(train$comment_text,2)</code></pre>
<pre><code>## [1] &quot;Explanation\nWhy the edits made under my username Hardcore Metallica Fan were reverted? They weren&#39;t vandalisms, just closure on some GAs after I voted at New York Dolls FAC. And please don&#39;t remove the template from the talk page since I&#39;m retired now.89.205.38.27&quot;
## [2] &quot;D&#39;aww! He matches this background colour I&#39;m seemingly stuck with. Thanks.  (talk) 21:51, January 11, 2016 (UTC)&quot;</code></pre>
<p>Now we create our own training and testing datasets:</p>
<pre class="r"><code>train_sub = sample.split(train$harmful, SplitRatio = 7/10)
new_train = train[train_sub,]
new_test = train[!train_sub,]</code></pre>
<p>We create new features based on our new training dataset and explore their relationships with column “harmful”. As we will be creating numeric features, we create a function to plot density and box plots.</p>
<pre class="r"><code>plot_column = function(train, column_x, plot_title, max){
   g1 = ggplot(train, aes_string(x = column_x)) + geom_density(aes(fill = harmful)) + coord_cartesian(xlim = c(0, max)) + ggtitle(plot_title) + scale_fill_manual(values = c(&quot;1&quot; = &quot;red&quot;, &quot;0&quot; = &quot;grey&quot;))
   
  g2 = ggplot(train, aes_string(y = column_x, x = &quot;harmful&quot;)) + geom_boxplot(aes(fill = harmful)) + coord_cartesian(xlim = c(0, 2000)) + ggtitle(plot_title) + scale_fill_manual(values = c(&quot;1&quot; = &quot;red&quot;, &quot;0&quot; = &quot;grey&quot;)) + coord_cartesian(ylim = c(0, max))
   
  grid.arrange(g1, g2, ncol = 2)  
}</code></pre>
<div id="length-of-comments-number-of-characters" class="section level5">
<h5>Length of comments: Number of characters</h5>
<p>We would expect that harmful comments would be, on average, shorter than harmless comments as harmless comments would seek to offer explanations while harmful comments would dive right into attacks. Let’s take a look.</p>
<pre class="r"><code>new_train$length_comment = nchar(new_train$comment_text)
new_train %&gt;%
  group_by(harmful) %&gt;%
  summarise(median_length = median(length_comment), mean_length = mean(length_comment))</code></pre>
<pre><code>## # A tibble: 2 x 3
##   harmful median_length mean_length
##   &lt;fct&gt;           &lt;dbl&gt;       &lt;dbl&gt;
## 1 0                 217        406.
## 2 1                 128        308.</code></pre>
<p>Mean and median length of harmless comments are greater than those of harmful comments.</p>
<p>Let’s look at distribution of length of comments:</p>
<pre class="r"><code>plot_column(new_train, &quot;length_comment&quot;, &quot;Length of Comments&quot;, 2000)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-5-1.png" width="1152" /></p>
<p>On average, harmful comments are shorter then harmless comments.</p>
</div>
<div id="length-of-comments-number-of-words" class="section level4">
<h4>Length of comments: Number of words</h4>
<pre class="r"><code>new_train$number_of_raw_words = as.vector(apply(X = new_train[,1, drop = F], MARGIN = 1, FUN = wordcount))
plot_column(new_train, &quot;number_of_raw_words&quot;, &quot;Number of words&quot;, 500)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-6-1.png" width="1152" /></p>
<p>Similar to number of characters, number of words is lower in harmful comments.</p>
</div>
<div id="average-length-of-words" class="section level4">
<h4>Average length of words</h4>
<p>We will use a simplified method to calculate the average length of words in a comment - we will include space in the number of characters.</p>
<pre class="r"><code>new_train$average_length_of_words = new_train$length_comment/new_train$number_of_raw_words
plot_column(new_train, &quot;average_length_of_words&quot;, &quot;Average Length of Words&quot;, 20)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-7-1.png" width="1152" /></p>
<p>Harmful comments use shorter words on average.</p>
</div>
<div id="proportion-of-repeated-words" class="section level4">
<h4>Proportion of repeated words</h4>
<p>We would expect that harmless comments use repetition less than harmful comments as harmless comments are aimed at passing a message whereas harmful comments are emotional and use repetitive words for emphasis.</p>
<pre class="r"><code>english_stopwords = stopwords(&quot;english&quot;)

clean_comments = function(x){
  x = tolower(x)
  x = gsub(&quot;[0-9]&quot;, &quot; &quot;, x)
  x = gsub(&quot;\n&quot;, &quot; &quot;, x)
  x = gsub(&quot;\t&quot;, &quot; &quot;, x)
  x = gsub(&quot;\\s+&quot;, &quot; &quot;, x)
  d = unlist(strsplit(x, &quot; &quot;))
  d = d[!(d %in% english_stopwords) &amp; nchar(d) &gt; 2]
  x = paste(d, collapse = &quot; &quot;)
  x = gsub(&quot;[^a-z&#39;]&quot;, &quot; &quot;, x)
  x = gsub(&quot;\\s+&quot;, &quot; &quot;, x)
  return(x)
}



remove_repeated_words = function(x){
  x = tolower(x)
  x = gsub(&quot;[0-9]&quot;, &quot; &quot;, x)
  x = gsub(&quot;\n&quot;, &quot; &quot;, x)
  x = gsub(&quot;\t&quot;, &quot; &quot;, x)
  x = gsub(&quot;\\s+&quot;, &quot; &quot;, x)
  d = unlist(strsplit(x, &quot; &quot;))
  d = d[!(d %in% english_stopwords) &amp; nchar(d) &gt; 2]
  x = paste(unique(d), collapse = &quot; &quot;)
  x = gsub(&quot;[^a-z&#39;]&quot;, &quot; &quot;, x)
  x = gsub(&quot;\\s+&quot;, &quot; &quot;, x)
  return(x)
  
}

new_train$cleaned_comments = as.vector(apply(X = new_train[,1, drop = F], MARGIN = 1, FUN = clean_comments))

new_train$unique_word_comments = as.vector(apply(X = new_train[,1, drop = F], MARGIN = 1, FUN = remove_repeated_words))


new_train$number_words_cleaned = as.vector(apply(X = new_train[,6, drop = F], MARGIN = 1, FUN = wordcount))
new_train$number_words_unique = as.vector(apply(X = new_train[,7, drop = F], MARGIN = 1, FUN = wordcount))
new_train$proportion_repeated_words = 1 - new_train$number_words_unique/new_train$number_words_cleaned
new_train[4,]</code></pre>
<pre><code>##                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         comment_text
## 4 &quot;\nMore\nI can&#39;t make any real suggestions on improvement - I wondered if the section statistics should be later on, or a subsection of &quot;&quot;types of accidents&quot;&quot;  -I think the references may need tidying so that they are all in the exact same format ie date format etc. I can do that later on, if no-one else does first - if you have any preferences for formatting style on references or want to do it yourself please let me know.\n\nThere appears to be a backlog on articles for review so I guess there may be a delay until a reviewer turns up. It&#39;s listed in the relevant form eg Wikipedia:Good_article_nominations#Transport  &quot;
##   harmful length_comment number_of_raw_words average_length_of_words
## 4       0            622                 110                5.654545
##                                                                                                                                                                                                                                                                                                                                                                                   cleaned_comments
## 4 make real suggestions improvement wondered section statistics later on subsection types accidents think references may need tidying exact format date format etc can later on no one else first preferences formatting style references want please let know appears backlog articles review guess may delay reviewer turns up listed relevant form wikipedia good article nominations transport
##                                                                                                                                                                                                                                                                                                                                                unique_word_comments
## 4 make real suggestions improvement wondered section statistics later on subsection types accidents think references may need tidying exact format date etc can no one else first preferences formatting style want please let know appears backlog articles review guess delay reviewer turns up listed relevant form wikipedia good article nominations transport
##   number_words_cleaned number_words_unique proportion_repeated_words
## 4                   55                  50                0.09090909</code></pre>
<pre class="r"><code>plot_column(new_train, &quot;proportion_repeated_words&quot;, &quot;Proportion of Repeated Words&quot;, 1)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-9-1.png" width="1152" /></p>
<p>The boxplot contradicts our hypothesis that harmful comments have a higher proportion of repeated words. However, the density plot shows outliers (comments with very high proportion of repeated words) that are dominantly harmful comments. This would be representative of comments whereby the commenter dove into curse words from the first word. Let’s zoom into the outliers:</p>
<pre class="r"><code>table(Proportion_repeated_words = new_train$proportion_repeated_words &gt; 0.9, Harmful = new_train$harmful)</code></pre>
<pre><code>##                          Harmful
## Proportion_repeated_words      0      1
##                     FALSE 100287  11152
##                     TRUE      40    203</code></pre>
<pre class="r"><code>ggplot(new_train, aes(x = proportion_repeated_words)) + geom_density(aes(fill = harmful)) + coord_cartesian(xlim = c(0.9, 1)) + ggtitle(&quot;Proportion of Repeated Words&quot;) + scale_fill_manual(values = c(&quot;1&quot; = &quot;red&quot;, &quot;0&quot; = &quot;grey&quot;))</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<p>A better predictor of harmful comments, in place of proportion of repeated words, an indicator variable indicating whether the proportion of repeated words is very high (higher than say 0.9).</p>
<pre class="r"><code>new_train$extreme_repetition = factor(if_else(new_train$proportion_repeated_words &gt; 0.9, 1, 0))</code></pre>
</div>
<div id="special-characters-and-punctuation-in-comments" class="section level4">
<h4>Special characters and punctuation in comments</h4>
<p>We’ld expect that harmful comments have more special characters and punctuations such as * and exclamation marks. Let’s see if the data supports this.</p>
<div id="clustered-exclamation-marks" class="section level5">
<h5>Clustered exclamation marks</h5>
<p>We look at both the number of exclamation marks and the presence of a chain of exclamation marks such as !!!!!!!</p>
<pre class="r"><code>new_train$number_exclamation_marks = str_count(new_train$comment_text, &quot;!&quot;)
print(tapply(new_train$number_exclamation_marks, new_train$harmful, mean))</code></pre>
<pre><code>##         0         1 
## 0.3328118 3.4058813</code></pre>
<p>Mean number of exclamation marks in harmful comments is 10 times higher than in harmless comments.</p>
<pre class="r"><code>plot_column(new_train, &quot;number_exclamation_marks&quot;, &quot;Number of Exclamation Marks&quot;, 20)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-14-1.png" width="1152" /></p>
<pre class="r"><code>new_train$clustered_exclamation_marks = grepl(&quot;!{2,}&quot;,new_train$comment_text)
round(prop.table(table(Clustered_exclamation_marks = new_train$clustered_exclamation_marks, Harmful = new_train$harmful), margin = 2),2)</code></pre>
<pre><code>##                            Harmful
## Clustered_exclamation_marks    0    1
##                       FALSE 0.99 0.91
##                       TRUE  0.01 0.09</code></pre>
<p>9% of harmful comments have clustered exclamation marks as opposed to only 1% of harmless comments.</p>
</div>
</div>
<div id="asterisks" class="section level4">
<h4>Asterisks</h4>
<pre class="r"><code>new_train$number_asterisks = str_count(new_train$comment_text, &quot;\\*&quot;)
new_train$asterisk = grepl(&quot;\\*&quot;, new_train$comment_text)
round(prop.table(table(Asterisks = new_train$asterisk, Harmful = new_train$harmful), margin = 2),2)</code></pre>
<pre><code>##          Harmful
## Asterisks    0    1
##     FALSE 0.99 0.97
##     TRUE  0.01 0.03</code></pre>
<pre class="r"><code>plot_column(new_train, &quot;number_asterisks&quot;, &quot;Number of Asterisks&quot;, 5)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-16-1.png" width="1152" /></p>
<p>Asterisks do not appear to be strong features of harmful comments thus we exclude them from our data.</p>
<pre class="r"><code>new_train = new_train %&gt;% select(-number_asterisks, -asterisk)</code></pre>
</div>
<div id="casing-of-comments---use-of-all-uppercase-letters" class="section level4">
<h4>Casing of comments - use of all uppercase letters</h4>
<p>We would expect that harmful comments would use more uppercase letters as an expression of emotions such as anger.</p>
<div id="proportion-of-uppercase-letters" class="section level5">
<h5>Proportion of uppercase letters</h5>
<pre class="r"><code>new_train$proportion_uppercase_letters = str_count(new_train$comment_text, &quot;[A-Z]&quot;)/
  nchar(new_train$comment_text)
plot_column(new_train, &quot;proportion_uppercase_letters&quot;, &quot;Proportion of Uppercase Letters&quot;, 1)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>On average, harmful comments have a higher proportion of upper case letters according to the boxplot. From the density plot, we see the bump around 0.75 indicating a rise in proportion of upper case letters amongst harmful comments. Let us zoom into this:</p>
<pre class="r"><code>ggplot(new_train, aes(x = proportion_uppercase_letters)) + geom_density(aes(fill = harmful)) + coord_cartesian(xlim = c(0.7, 1)) + ggtitle(&quot;Proportion of Uppercase Letters&quot;) + scale_fill_manual(values = c(&quot;1&quot; = &quot;red&quot;, &quot;0&quot; = &quot;grey&quot;))</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<p>We create a column indicating whether a comment has a very high proportion of uppercase letters.</p>
<pre class="r"><code>new_train$extreme_uppercase = factor(if_else(new_train$proportion_uppercase_letters &gt; 0.7, 1, 0))</code></pre>
</div>
<div id="clustered-uppercase-letters" class="section level5">
<h5>Clustered uppercase letters</h5>
<pre class="r"><code>new_train$clustered_uppercase = grepl(&quot;[A-Z]{5,}&quot;, new_train$comment_text)

round(prop.table(table(Harmful = new_train$harmful, clustered_uppercase = new_train$clustered_uppercase), margin = 1) * 100)</code></pre>
<pre><code>##        clustered_uppercase
## Harmful FALSE TRUE
##       0    92    8
##       1    79   21</code></pre>
<p>Harmful comments are approximately 3 times more likely to have clustered (a chain of at least 5) uppercase letters as compared to harmless comments.</p>
</div>
</div>
<div id="presence-of-pronoun-you" class="section level4">
<h4>Presence of pronoun “you”</h4>
<p>Harmful comments are likely to be targetted at specific individuals and use of “you” is a good indicator that a comment is less likely a general comment than a targetted comment.</p>
<pre class="r"><code>new_train$you_comment_text = gsub(&quot;you&#39;re&quot;, &quot;you are&quot;, new_train$comment_text, ignore.case = TRUE)
new_train$presence_of_you = grepl(&quot; you &quot;, new_train$comment_text, ignore.case = TRUE)
prop.table(table(Presence_of_you = new_train$presence_of_you, Harmful = new_train$harmful), margin = 2)</code></pre>
<pre><code>##                Harmful
## Presence_of_you         0         1
##           FALSE 0.5891252 0.4661912
##           TRUE  0.4108748 0.5338088</code></pre>
<p>More than half (53%) of harmful comments contain the word you. Let us try the number of times you is used in a comment:</p>
<pre class="r"><code>new_train$number_of_you = str_count(tolower(new_train$comment_text),&quot; you &quot;)

plot_column(new_train, &quot;number_of_you&quot;, &quot;Number of pronoun &#39;you&#39;&quot;, 20)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-23-1.png" width="1152" /></p>
<p>On average, harmful comments have a higher number of “you”s, but harmless comments dominate harmful comments particularly in the lower counts of “you”. To standardize the number of you, we can calculate the proportion of you out of all the words use.</p>
<pre class="r"><code>new_train$proportion_of_you = new_train$number_of_you/new_train$number_of_raw_words
plot_column(new_train, &quot;proportion_of_you&quot;, &quot;Proportion of pronoun &#39;you&#39;&quot;, 0.5)</code></pre>
<p><img src="/post/toxic_comment_blog_part2_files/figure-html/unnamed-chunk-24-1.png" width="1152" /></p>
<p>Harmful comments have higher proportions of “you”.</p>
<p>There are many other features we could create from the dataset provided, but for now let us use what we have created. We will create the features in our testing dataset as we did in the training dataset then save the new datasets for use in our classification model.</p>
<p><img src="/post/toxic_comment_blog_part2_files/read_data.PNG" /></p>
<p><img src="/post/toxic_comment_blog_part2_files/scale.PNG" /></p>
<p><img src="/post/toxic_comment_blog_part2_files/map.PNG" /></p>
<p><img src="/post/toxic_comment_blog_part2_files/model.PNG" /></p>
<p>The additional features improves the recall of the previous model (based on the comments only) by 2% taking the recall to 60%. In the next post, we use deep learning to further improve the recall.</p>
</div>
